name: Run SAMP Server with LocalTunnel + DuckDNS

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # Ù‡Ø± Û¶ Ø³Ø§Ø¹Øª Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Clone repo
      uses: actions/checkout@v3

    - name: ğŸ›  Ù†ØµØ¨ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ù„Ø§Ø²Ù…
      run: |
        sudo apt update
        sudo apt install -y unzip curl wget nodejs npm
        sudo npm install -g localtunnel

    - name: ğŸ“¦ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„ ÙØ´Ø±Ø¯Ù‡ Ø³Ø±ÙˆØ±
      run: unzip -o LexusRP.zip -d LexusRP

    - name: ğŸŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¢ÛŒâ€ŒÙ¾ÛŒ DuckDNS
      run: |
        mkdir -p ~/duckdns
        echo "url=https://www.duckdns.org/update?domains=lexusrp&token=af9e1af2-cc2f-433d-816a-8c75fed13594&ip=" > ~/duckdns/duck.conf
        curl -k -o ~/duckdns/duck.log -K ~/duckdns/duck.conf

    - name: ğŸš‡ Ø§Ø¬Ø±Ø§ÛŒ LocalTunnel Ø±ÙˆÛŒ Ù¾ÙˆØ±Øª 7777
      run: |
        lt --port 7777 --subdomain lexusrp > tunnel.log &
        sleep 10
        tail -n 20 tunnel.log

    - name: ğŸ§· Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¬Ø±Ø§ÛŒÛŒ Ø¨Ù‡ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÙˆØ±
      run: |
        chmod -R +x LexusRP/LexusRP
        chmod +x LexusRP/LexusRP/samp03svr
        chmod +x LexusRP/LexusRP/announce || echo "âš ï¸ ÙØ§ÛŒÙ„ announce Ø§Ø¬Ø±Ø§ÛŒÛŒ Ù†ÛŒØ³Øª ÛŒØ§ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯"

    - name: ğŸš€ Ø§Ø¬Ø±Ø§ÛŒ Ø³Ø±ÙˆØ± SAMP
      run: |
        cd LexusRP/LexusRP
        nohup ./samp03svr > server.log 2>&1 &
        sleep 5

        echo "ğŸ“„ Ù„Ø§Ú¯ Ø³Ø±ÙˆØ± (40 Ø®Ø· Ø¢Ø®Ø±):"
        tail -n 40 server.log

        echo "ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø´Ú©Ù„Ø§Øª:"
        if grep -i "error" server.log; then echo 'âŒ Ø§Ø±ÙˆØ± Ø¯Ø± Ù„Ø§Ú¯ ÛŒØ§ÙØª Ø´Ø¯'; fi
        if grep -i "plugin" server.log; then echo 'ğŸ”Œ Ø¨Ø±Ø±Ø³ÛŒ Plugin: OK'; fi
        if grep -i "gamemode" server.log; then echo 'ğŸ® Ø¨Ø±Ø±Ø³ÛŒ Gamemode: OK'; fi
        if ! grep -i "started" server.log; then echo 'âš ï¸ Ø³Ø±ÙˆØ± Ø¨Ù‡â€ŒØ·ÙˆØ± Ú©Ø§Ù…Ù„ Ø±Ø§Ù† Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª'; fi

    - name: âœ… Ù†ØªÛŒØ¬Ù‡ Ù†Ù‡Ø§ÛŒÛŒ
      run: |
        echo "âœ… Ø§Ú¯Ø± Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø¯Ø±Ø³Øª Ø¨ÙˆØ¯ØŒ Ø§Ø² Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± ÙˆØ§Ø±Ø¯ Ø´Ùˆ:"
        echo "ğŸŒ LexusRP.DuckDNS.org:7777"
        echo "ğŸŒ lexusrp.loca.lt:7777"
