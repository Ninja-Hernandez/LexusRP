name: Run SAMP Server

on:
  workflow_dispatch:
  push:

jobs:
  run-server:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Clone Repository
      uses: actions/checkout@v3

    - name: ğŸ›  Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y unzip curl wget nodejs npm
        sudo npm install -g localtunnel

    - name: ğŸ“¦ Extract ZIP and Show Contents
      run: |
        echo "ğŸ“¦ Extracting LexusRP_Final.zip ..."
        unzip -o LexusRP_Final.zip -d LexusRP
        echo "ğŸ“ Contents of LexusRP:"
        ls -la LexusRP || true
        find LexusRP -type f

    - name: ğŸŒ Update DuckDNS IP
      run: |
        mkdir -p ~/duckdns
        echo "url=https://www.duckdns.org/update?domains=lexusrp&token=af9e1af2-cc2f-433d-816a-8c75fed13594&ip=" > ~/duckdns/duck.conf
        curl -k -o ~/duckdns/duck.log -K ~/duckdns/duck.conf

    - name: ğŸš‡ Start LocalTunnel
      run: |
        lt --port 7777 --subdomain lexusrp > tunnel.log &
        sleep 10
        tail -n 20 tunnel.log || echo "âš ï¸ LocalTunnel may not have output yet"

    - name: ğŸ”§ Make Files Executable
      run: |
        echo "ğŸ” Looking for samp03svr..."
        find LexusRP -name samp03svr -exec chmod +x {} \; || echo "âš ï¸ samp03svr not found"
        find LexusRP -name announce -exec chmod +x {} \; || echo "âš ï¸ announce not found"

    - name: ğŸš€ Run SAMP Server
      run: |
        echo "ğŸ” Searching for samp03svr to run..."
        SAMP_PATH=$(find LexusRP -name samp03svr | head -n 1)
        if [ -z "$SAMP_PATH" ]; then
          echo "âŒ samp03svr not found. Cannot start server."
          exit 1
        fi
        cd $(dirname "$SAMP_PATH")
        echo "âœ… Running SAMP Server in: $(pwd)"
        nohup ./samp03svr > server.log 2>&1 &
        sleep 5
        echo "ğŸ“„ Last 40 lines of server.log:"
        tail -n 40 server.log || echo "âš ï¸ Log not found"

    - name: âœ… Done
      run: |
        echo "âœ… Server startup script completed."
        echo "ğŸ“¡ Connect using:"
        echo "ğŸ”— LexusRP.DuckDNS.org:7777"
        echo "ğŸ”— lexusrp.loca.lt:7777"
