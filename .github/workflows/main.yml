name: Start SAMP Server with LocalTunnel + DuckDNS

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # Ø§Ø¬Ø±Ø§ Ù‡Ø± 6 Ø³Ø§Ø¹Øª

jobs:
  run-samp:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: ğŸ“¥ Ø¯Ø±ÛŒØ§ÙØª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø§Ø² Ù…Ø®Ø²Ù†
      uses: actions/checkout@v3

    - name: ğŸ›  Ù†ØµØ¨ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ù„Ø§Ø²Ù…
      run: |
        sudo apt update
        sudo apt install -y unzip wget curl screen lib32z1 nodejs npm
        sudo npm install -g localtunnel

    - name: ğŸ“¦ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„ Ø³Ø±ÙˆØ±
      run: |
        unzip -o LexusRP.zip -d unpacked

    - name: âœ… ØªÙ†Ø¸ÛŒÙ… Ø³Ø·Ø­ Ø¯Ø³ØªØ±Ø³ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
      run: |
        cd unpacked/LexusRP
        chmod +x samp03svr
        chmod +x announce

    - name: ğŸŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ IP Ø¯Ø± DuckDNS
      run: |
        curl -s "https://www.duckdns.org/update?domains=lexusrp&token=af9e1af2-cc2f-433d-816a-8c75fed13594&ip="

    - name: ğŸš‡ Ø§Ø¬Ø±Ø§ÛŒ LocalTunnel Ø±ÙˆÛŒ Ù¾ÙˆØ±Øª 7777
      run: |
        lt --port 7777 --subdomain lexusrp > lt.log &
        sleep 5
        echo "LocalTunnel started."

    - name: ğŸš€ Ø§Ø¬Ø±Ø§ÛŒ Ø³Ø±ÙˆØ± SAMP
      run: |
        cd unpacked/LexusRP
        screen -dmS samp ./samp03svr
        sleep 10

    - name: ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ù¾ÙˆØ±Øª 7777
      run: |
        echo "ğŸ§ª Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ± Ø¯Ø± Ù¾ÙˆØ±Øª 7777:"
        (echo > /dev/tcp/127.0.0.1/7777) &>/dev/null && echo "âœ… Ù¾ÙˆØ±Øª Ø¨Ø§Ø²Ù‡" || echo "â›”ï¸ Ù¾ÙˆØ±Øª 7777 Ø¨Ø³ØªÙ‡â€ŒØ³Øª (Ø³Ø±ÙˆØ± Ø±Ø§Ù† Ù†Ø´Ø¯Ù‡)"

    - name: ğŸ“„ Ø¨Ø±Ø±Ø³ÛŒ Ù„Ø§Ú¯ Ø³Ø±ÙˆØ±
      run: |
        cd unpacked/LexusRP
        if [ -f server_log.txt ]; then
          echo "ğŸ“„ Ù„Ø§Ú¯ Ú©Ø§Ù…Ù„:"
          tail -n 50 server_log.txt
        else
          echo "â›”ï¸ server_log.txt ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ø³Ø±ÙˆØ± ÙÙˆØ±Ø§Ù‹ Ú©Ø±Ø´ Ú©Ø±Ø¯Ù‡"
        fi

    - name: ğŸ§  Ø¨Ø±Ø±Ø³ÛŒ Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø±Ø§ÛŒØ¬
      run: |
        cd unpacked/LexusRP
        if [ -f server_log.txt ]; then
          grep -i "error" server_log.txt || echo "âœ”ï¸ Ø¨Ø¯ÙˆÙ† Ø§Ø±ÙˆØ± Ø®Ø§Øµ"
          grep -i "plugin" server_log.txt || echo "âœ”ï¸ Ù¾Ù„Ø§Ú¯ÛŒÙ†â€ŒÙ‡Ø§ Ù…Ø´Ú©Ù„ÛŒ Ù†Ø¯Ø§Ø´ØªÙ†"
          grep -i "gamemode" server_log.txt || echo "âœ”ï¸ Ú¯ÛŒÙ… Ù…ÙˆØ¯ Ù…Ø´Ú©Ù„ÛŒ Ù†Ø¯Ø§Ø´Øª"
        else
          echo "âŒ Ø¨Ø±Ø±Ø³ÛŒ Ù†Ø´Ø¯ Ú†ÙˆÙ† server_log.txt Ù†Ø¨ÙˆØ¯"
        fi

    - name: ğŸ“¢ Ù†ØªÛŒØ¬Ù‡ Ù†Ù‡Ø§ÛŒÛŒ
      run: |
        echo "âœ… Ø§Ú¯Ø± Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø¯Ø±Ø³Øª Ø¨ÙˆØ¯ØŒ ÙˆØ§Ø±Ø¯ Ø´Ùˆ:"
        echo "ğŸŒ Ø¢Ø¯Ø±Ø³ Ø³Ø±ÙˆØ± Ø¯Ø± SAMP Launcher:"
        echo "ğŸ”— lexusrp.loca.lt:7777"
        echo "ğŸ”— ÛŒØ§ Ø¯Ø§Ù…Ù†Ù‡: lexusrp.duckdns.org:7777"
