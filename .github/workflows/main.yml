name: Run SA-MP Server (Fast + Debug) with LocalTunnel + DuckDNS

on:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Clone repo
      uses: actions/checkout@v3

    - name: 🛠 نصب ابزارها
      run: |
        sudo apt update
        sudo apt install -y unzip curl wget nodejs npm lib32z1 lib32ncurses6 screen
        sudo npm install -g localtunnel

    - name: 📦 استخراج فایل ZIP
      run: unzip -o LexusRP.zip -d LexusRP

    - name: 🔓 اجرایی کردن فایل samp03svr
      run: |
        chmod +x LexusRP/LexusRP/samp03svr

    - name: 🚀 اجرای سریع سرور SAMP
      run: |
        cd LexusRP/LexusRP/
        screen -dmS samp ./samp03svr
        sleep 5
        echo "📄 بررسی سرور:"
        ps aux | grep samp03svr || echo "⛔️ samp03svr اجرا نشده!"
        echo "📄 لاگ آخر سرور:"
        tail -n 40 server.log || echo "server.log پیدا نشد"

    - name: 🌍 اجرای LocalTunnel برای پورت 7777
      run: |
        npx localtunnel --port 7777 --subdomain lexusrp > tunnel.log &
        sleep 10
        echo "📄 لاگ LocalTunnel (برای بررسی اتصال):"
        tail -n 20 tunnel.log

    - name: 🦆 آپدیت آی‌پی DuckDNS
      run: |
        curl -s "https://www.duckdns.org/update?domains=lexusrp&token=af9e1af2-cc2f-433d-816a-8c75fed13594&ip="

    - name: 🔍 تست وضعیت سرور (برای رفع مشکل Loading)
      run: |
        echo "🧪 بررسی وضعیت سرور در پورت 7777:"
        timeout 5 bash -c "</dev/tcp/127.0.0.1/7777" && echo "✅ پورت 7777 بازه (سرور ران شده)" || echo "⛔️ پورت 7777 بسته‌ست (سرور ران نشده)"
        echo "🚀 اگر پورت باز بود ولی هنوز در SAMP نوشته LOADING:"
        echo "🔹 بررسی کن gamemode و plugin درست لود شدن؟"
        echo "🔹 سرور با localtunnel به درستی متصل شده؟"
        echo "🔹 فایروال یا ارور دیتابیس باعث کرش نشده؟"
