name: Run SAMP Server with LocalTunnel + DuckDNS + Debug

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y unzip curl wget nodejs npm
        sudo npm install -g localtunnel

    - name: Unzip SAMP Server Files
      run: unzip -o LexusRP.zip -d LexusRP

    - name: Check SAMP Files Before Run
      run: |
        echo "๐ ุจุฑุฑุณ ูุงูโูุง ุณุฑูุฑ ุจุนุฏ ุงุฒ unzip:"
        ls -R LexusRP

    - name: Update DuckDNS IP
      run: |
        mkdir -p ~/duckdns
        echo "url=https://www.duckdns.org/update?domains=lexusrp&token=af9e1af2-cc2f-433d-816a-8c75fed13594&ip=" > ~/duckdns/duck.conf
        curl -k -o ~/duckdns/duck.log -K ~/duckdns/duck.conf

    - name: Run LocalTunnel + SAMP Server and Debug Logs
      run: |
        set -x

        # ุงุฌุฑุง localtunnel
        lt --port 7777 --subdomain lexusrp > tunnel.log 2>&1 &
        sleep 10
        echo "=== LocalTunnel Log (last 20 lines) ==="
        tail -n 20 tunnel.log || echo "โ tunnel.log ูพุฏุง ูุดุฏ!"

        # ุฏุงุฏู ุฏุณุชุฑุณ ุงุฌุฑุง ุจู ุชูุงู ูุงูโูุง ุณุฑูุฑ
        chmod -R +x LexusRP/LexusRP/sampserver/samp03

        echo "๐ ุจุฑุฑุณ ูุงูโูุง plugins ู gamemodes:"
        ls -l LexusRP/LexusRP/sampserver/samp03/plugins || echo "โ ูพูุดู plugins ูพุฏุง ูุดุฏ!"
        ls -l LexusRP/LexusRP/sampserver/samp03/gamemodes || echo "โ ูพูุดู gamemodes ูพุฏุง ูุดุฏ!"

        echo "๐ ุงุฌุฑุง ุณุฑูุฑ"
        cd LexusRP/LexusRP/sampserver/samp03
        nohup ./samp03svr > server.log 2>&1 &
        sleep 10

        echo "๐ ุจุฑุฑุณ ูุงู server.log"
        if [ -f server.log ]; then
          echo "โ ูุงู server.log ูพุฏุง ุดุฏ:"
          tail -n 40 server.log
        else
          echo "โ ูุงู server.log ุณุงุฎุชู ูุดุฏู!"
          ls -l
        fi

        echo "โ๏ธ ุจุฑุฑุณ ุฎุทุงูุง ุฑุงุฌ ุฏุฑ ุณุฑูุฑ"
        if grep -q "failed to load plugin" server.log; then
          echo "โ ุฎุทุง: ูพูุงฺฏู ูุงูุต ุง ุฎุฑุงุจ"
        fi

        if grep -q "gamemode load failed" server.log; then
          echo "โ ุฎุทุง: ฺฏูโููุฏ ุจุงุฑฺฏุฐุงุฑ ูุดุฏู"
        fi

        if grep -q "Could not bind to port" server.log; then
          echo "โ ุฎุทุง: ูพูุฑุช 7777 ุฏุฑ ุฏุณุชุฑุณ ูุณุช"
        fi

        if ! grep -q "Server started" server.log; then
          echo "โ๏ธ ูุดุฏุงุฑ: ุณุฑูุฑ ฺฉุงูู ุงุฌุฑุง ูุดุฏู ุง ุฏุฑ LOADING ฺฏุฑ ฺฉุฑุฏู!"
        fi

        if grep -q "Error" tunnel.log; then
          echo "โ ุฎุทุง: ุชููู LocalTunnel ุฏฺุงุฑ ูุดฺฉู ุดุฏ"
        fi

    - name: โ Success Message
      run: |
        echo "โ ุงฺฏุฑ ุจุงูุง ุงููุฏูุ ูุงุฑุฏ ุขุฏุฑุณ ุดู:"
        echo "๐ lexusrp.loca.lt:7777 ุง lexusrp.duckdns.org:7777"
