name: Run SAMP Server with Remote.it + DuckDNS

on:
  workflow_dispatch:  # اجرای دستی
  schedule:
    - cron: "0 */6 * * *"  # اجرای خودکار هر 6 ساعت

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y unzip curl wget gnupg

    - name: Unzip SAMP Server
      run: unzip -o LexusRP.zip -d LexusRP

    - name: Update DuckDNS IP
      run: |
        mkdir -p ~/duckdns
        echo "url=https://www.duckdns.org/update?domains=lexusrp&token=af9e1af2-cc2f-433d-816a-8c75fed13594&ip=" > ~/duckdns/duck.conf
        curl -k -o ~/duckdns/duck.log -K ~/duckdns/duck.conf

    - name: Install Remote.it CLI
      run: |
        wget https://downloads.remote.it/cli/remoteit-cli-linux-arm64.gz
        gunzip remoteit-cli-linux-arm64.gz
        chmod +x remoteit-cli-linux-arm64
        sudo mv remoteit-cli-linux-arm64 /usr/local/bin/remoteit

    - name: Login to Remote.it
      run: |
        remoteit logout || true
        remoteit login --email Parsabakhtazad1@gmail.com --password ${{ secrets.REMOTEIT_PASS }}

    - name: Register Remote.it Device + Port 7777
      run: |
        remoteit agent start
        remoteit device register --name "LexusSAMP" --type generic
        remoteit service add --name "SAMP7777" --port 7777 --host 127.0.0.1 --type tcp
        remoteit agent restart

    - name: Run SAMP Server
      run: |
        chmod +x LexusRP/LexusRP/sampserver/samp03/samp03svr
        cd LexusRP/LexusRP/sampserver/samp03
        nohup ./samp03svr > server.log 2>&1 &

    - name: Done
      run: echo "✅ Server started successfully at http://lexusrp.duckdns.org:7777"
