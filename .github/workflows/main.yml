name: Run SAMP Server with Ngrok + DuckDNS

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */3 * * *"  # هر ۳ ساعت خودکار اجرا میشه

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: نصب ابزارهای موردنیاز
        run: |
          sudo apt update
          sudo apt install screen unzip wget curl -y

      - name: دانلود و استخراج سرور SAMP
        run: |
          wget https://github.com/Ninja-Hernandez/LexusRP/raw/main/LexusRP.zip -O server.zip
          unzip server.zip
          chmod +x samp03svr

      - name: نصب و اجرای Ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok -y
          ngrok config add-authtoken 2zgPZNenzSYjTDNseaBz7BRTbYY_5XDmZur14W15WEoZwgWsp
          screen -dmS tunnel ngrok tcp 7777

      - name: صبر برای گرفتن آدرس جدید از Ngrok
        run: sleep 10

      - name: گرفتن IP جدید و تنظیم روی DuckDNS
        run: |
          IP=$(curl -s http://127.0.0.1:4040/api/tunnels | grep -o 'tcp://[^"]*' | sed 's/tcp:\/\///')
          echo "IP جدید: $IP"
          curl "https://www.duckdns.org/update?domains=lexusrp&token=af9e1af2-cc2f-433d-816a-8c75fed13594&ip=$(echo $IP | cut -d: -f1)"
          echo "پورت NGROK: $(echo $IP | cut -d: -f2)"

      - name: اجرای سرور SAMP
        run: |
          screen -dmS samp ./samp03svr
          sleep 300
