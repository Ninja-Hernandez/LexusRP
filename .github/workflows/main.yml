name: Start SAMP Server via LocalTunnel + Debug Tools

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  run-samp-server:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ›  Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y unzip screen wget curl lib32z1 nodejs npm
          npm install -g localtunnel

      - name: ğŸ“¦ Extract Server Files
        run: |
          unzip -o LexusRP.zip -d unpacked
          chmod +x unpacked/LexusRP/samp03svr || echo "âŒ samp03svr Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!"
          chmod +x unpacked/LexusRP/announce || echo "âŒ announce Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!"
          ls -l unpacked/LexusRP/

      - name: ğŸš€ Run SAMP Server
        run: |
          cd unpacked/LexusRP
          nohup ./samp03svr > server.log 2>&1 &
          sleep 5
          echo "âœ… SAMP Server started"

      - name: ğŸŒ Start LocalTunnel
        run: |
          lt --port 7777 --subdomain lexusrp > ltlog.txt &
          sleep 10
          echo "=== Tunnel URL ==="
          tail -n 5 ltlog.txt || echo "â›”ï¸ LocalTunnel Ø®Ø±ÙˆØ¬ÛŒ Ù†Ø¯Ø§Ø±Ø¯"

      - name: ğŸ¦† Update DuckDNS IP
        run: |
          curl -s "https://www.duckdns.org/update?domains=lexusrp&token=af9e1af2-cc2f-433d-816a-8c75fed13594&ip="

      - name: ğŸ” Check Port Status
        run: |
          echo "ğŸ§ª Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ± Ø¯Ø± Ù¾ÙˆØ±Øª 7777:"
          (echo > /dev/tcp/127.0.0.1/7777) &>/dev/null && echo "âœ… Ù¾ÙˆØ±Øª Ø¨Ø§Ø²Ù‡!" || echo "â›”ï¸ Ù¾ÙˆØ±Øª 7777 Ø¨Ø³ØªÙ‡â€ŒØ³Øª (Ø³Ø±ÙˆØ± Ø±Ø§Ù† Ù†Ø´Ø¯Ù‡)"

      - name: ğŸ“„ Read server.log
        run: |
          if [ -f unpacked/LexusRP/server.log ]; then
            tail -n 40 unpacked/LexusRP/server.log
          else
            echo "â›”ï¸ ÙØ§ÛŒÙ„ server.log Ø³Ø§Ø®ØªÙ‡ Ù†Ø´Ø¯Ù‡ØŒ ÛŒØ¹Ù†ÛŒ Ø³Ø±ÙˆØ± ÙÙˆØ±Ø§Ù‹ Ú©Ø±Ø´ Ú©Ø±Ø¯Ù‡"
          fi

      - name: ğŸ§  Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø±ÙˆØ±Ù‡Ø§
        run: |
          echo "ğŸ“‹ Ø¨Ø±Ø±Ø³ÛŒ Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø±Ø§ÛŒØ¬:"
          grep -i "error" unpacked/LexusRP/server.log || echo "âœ”ï¸ Ø¨Ø¯ÙˆÙ† Ø§Ø±ÙˆØ± Ø®Ø§Øµ"
          grep -i "plugin" unpacked/LexusRP/server.log || echo "âœ”ï¸ Ù¾Ù„Ø§Ú¯ÛŒÙ†â€ŒÙ‡Ø§ Ù…Ø´Ú©Ù„ÛŒ Ù†Ø¯Ø§Ø´ØªÙ†"
          grep -i "gamemode" unpacked/LexusRP/server.log || echo "âœ”ï¸ Ú¯ÛŒÙ… Ù…ÙˆØ¯ Ù…Ø´Ú©Ù„ÛŒ Ù†Ø¯Ø§Ø´Øª"
