name: Run SAMP Server with LocalTunnel + DuckDNS

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # ูุฑ ถ ุณุงุนุช ุงุฌุฑุง ูุดู

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: ๐ฅ Clone repo
      uses: actions/checkout@v3

    - name: ๐ ูุตุจ ุงุจุฒุงุฑูุง
      run: |
        sudo apt update
        sudo apt install -y unzip curl wget nodejs npm
        sudo npm install -g localtunnel

    - name: ๐ฆ ุจุงุฒ ฺฉุฑุฏู ูุงู ZIP
      run: unzip -o LexusRP.zip -d LexusRP

    - name: ๐ ุจูโุฑูุฒุฑุณุงู ุขโูพ DuckDNS
      run: |
        mkdir -p ~/duckdns
        echo "url=https://www.duckdns.org/update?domains=lexusrp&token=af9e1af2-cc2f-433d-816a-8c75fed13594&ip=" > ~/duckdns/duck.conf
        curl -k -o ~/duckdns/duck.log -K ~/duckdns/duck.conf

    - name: ๐ ุงุฌุฑุง LocalTunnel ุฑู ูพูุฑุช 7777
      run: |
        lt --port 7777 --subdomain lexusrp > tunnel.log &
        sleep 10
        echo "=== LocalTunnel Log (last 20 lines) ==="
        tail -n 20 tunnel.log

    - name: ๐ ุชูุธู ุฏุณุชุฑุณโูุง ู ุจุฑุฑุณ ูุงูโูุง
      run: |
        chmod -R +x LexusRP/LexusRP
        echo "๐ ุจุฑุฑุณ ูพูุดู Plugins:"
        ls -l LexusRP/LexusRP/plugins || echo "ูพูุดู Plugins ุงูุช ูุดุฏ"
        echo "๐ ุจุฑุฑุณ ูพูุดู Gamemodes:"
        ls -l LexusRP/LexusRP/gamemodes || echo "ูพูุดู Gamemodes ุงูุช ูุดุฏ"

    - name: ๐ ุงุฌุฑุง ุณุฑูุฑ SAMP
      run: |
        cd LexusRP/LexusRP
        nohup ./samp03svr > server.log 2>&1 &
        sleep 8
        echo "๐ ูุญุชูุงุช server.log (ุขุฎุฑู 40 ุฎุท):"
        tail -n 40 server.log

    - name: ๐ ุจุฑุฑุณ ูุงฺฏ ุจุฑุง ูุดฺฉูุงุช ุงุญุชูุงู
      run: |
        cd LexusRP/LexusRP
        echo "๐ ุดุฑูุน ุจุฑุฑุณ ูุงฺฏ ุจุฑุง ูุดฺฉูุงุช ุงุญุชูุงู:"
        if grep -i "Run time error" server.log; then
          echo "โ ุงุฑูุฑ ุฒูุงู ุงุฌุฑุง (Run time error) ุงูุช ุดุฏ! ูุทูุง ฺฏูโููุฏ ู ุงุณฺฉุฑูพุชโูุง ุฑุง ุจุฑุฑุณ ฺฉูุฏ."
        fi
        if grep -i "could not load" server.log; then
          echo "โ ุงุฑูุฑ ุจุงุฑฺฏุฐุงุฑ ูุงู ูพุฏุง ุดุฏ. ุงุญุชูุงูุง ูุงูโูุง ฺฏูุดุฏู ุง ูุณุฑ ูุงุฏุฑุณุช ุฏุงุฑุฏ."
        fi
        if grep -i "failed to open" server.log; then
          echo "โ ุงุฑูุฑ ุจุงุฒฺฉุฑุฏู ูุงู ุฑุฎ ุฏุงุฏู. ููฺฉู ุงุณุช ูุงู ุง ุฏุณุชุฑุณโูุง ูุดฺฉู ุฏุงุดุชู ุจุงุดูุฏ."
        fi
        if grep -i "function is not found" server.log; then
          echo "โ ุชุงุจุน ฺฉู ูุฑุงุฎูุงู ุดุฏู ูพุฏุง ูุดุฏู. ุงุญุชูุงูุง ุฏุฑ ุงุณฺฉุฑูพุชโูุง ูุดฺฉู ุฏุงุฑุฏ."
        fi
        if grep -i "plugin error" server.log; then
          echo "โ ุฎุทุง ุฏุฑ ูพูุงฺฏูโูุง ูุฌูุฏ ุฏุงุฑุฏ. ูพูุงฺฏูโูุง ู ูุณุฑ ุขูโูุง ุฑุง ฺฺฉ ฺฉูุฏ."
        fi
        if ! grep -i "error" server.log && ! grep -i "failed" server.log; then
          echo "โ๏ธ ูฺ ุงุฑูุฑ ุฏุฑ ูุงฺฏ ูพุฏุง ูุดุฏ."
          echo "โ๏ธ ุจุง ุงู ุญุงู ุงุญุชูุงูุงู ุณุฑูุฑ ฺฉุงูู ุฑุงู ูุดุฏู. ุจุฑุฑุณโูุง ุฏฺฏุฑ ูุงุฒู ุงุณุช."
        fi

    - name: โ ูุชุฌู ููุง
      run: |
        echo "โ ุณุฑูุฑ ุงฺฏุฑ ุจู ุฏุฑุณุช ุงุฌุฑุง ุดุฏู ุจุงุดุฏุ ุงุฒ ุทุฑู ุขุฏุฑุณโูุง ุฒุฑ ูุงุฑุฏ ุดูุฏ:"
        echo "๐ LexusRP.DuckDNS.org:7777"
        echo "๐ lexusrp.loca.lt:7777"
