- name: Run LocalTunnel + SAMP Server and Check Logs
  run: |
    # شروع localtunnel و ذخیره لاگ
    lt --port 7777 --subdomain lexusrp > tunnel.log 2>&1 &
    sleep 10
    echo "=== LocalTunnel Log (last 20 lines) ==="
    tail -n 20 tunnel.log

    # شروع سرور SAMP و ذخیره لاگ
    chmod +x LexusRP/LexusRP/sampserver/samp03/samp03svr
    cd LexusRP/LexusRP/sampserver/samp03
    nohup ./samp03svr > server.log 2>&1 &
    sleep 10
    echo "=== Server Log (last 40 lines) ==="
    tail -n 40 server.log

    # چک کردن خطاهای رایج سرور
    if grep -q "failed to load plugin" server.log; then
      echo "⚠️ خطا: یکی از پلاگین‌ها بارگذاری نشده است!"
    fi

    if grep -q "Could not bind to port" server.log; then
      echo "⚠️ خطا: پورت 7777 اشغال شده یا در دسترس نیست!"
    fi

    if grep -q "gamemode load failed" server.log; then
      echo "⚠️ خطا: مشکل در بارگذاری گیم‌مود!"
    fi

    if ! grep -q "Server started" server.log; then
      echo "⚠️ هشدار: سرور کامل راه‌اندازی نشده یا ممکن است گیر کرده باشد!"
    fi

    # چک کردن وضعیت تونل localtunnel
    if grep -q "Error" tunnel.log; then
      echo "⚠️ خطا: تونل LocalTunnel به درستی اجرا نشده است!"
    fi
